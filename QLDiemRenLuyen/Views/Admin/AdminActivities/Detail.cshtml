@model QLDiemRenLuyen.Admin.Models.ViewModels.ActivityDetailVm
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Chi tiết hoạt động";
    var token = Antiforgery.GetAndStoreTokens(HttpContext).RequestToken;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">@Model.Title</h2>
    <div>
        <a class="btn btn-outline-secondary me-2" asp-action="Index"><i class="fa-solid fa-arrow-left me-1"></i>Quay lại</a>
        <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.Id"><i class="fa-solid fa-pen me-1"></i>Chỉnh sửa</a>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Thông tin chung</h5>
                <p class="mb-2"><strong>Học kỳ:</strong> @Model.TermName</p>
                <p class="mb-2"><strong>Tiêu chí:</strong> @Model.CriterionName</p>
                <p class="mb-2"><strong>Thời gian:</strong> @(Model.StartAt?.ToString("dd/MM/yyyy HH:mm") ?? "-") - @(Model.EndAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</p>
                <p class="mb-2"><strong>Địa điểm:</strong> @(string.IsNullOrWhiteSpace(Model.Location) ? "Chưa cập nhật" : Model.Location)</p>
                <p class="mb-2"><strong>Số lượng tối đa:</strong> @(Model.MaxSeats?.ToString() ?? "Không giới hạn")</p>
                <p class="mb-2"><strong>Điểm:</strong> @(Model.Points?.ToString("0.##") ?? "-")</p>
                <p class="mb-2"><strong>Người phụ trách:</strong> @(Model.OrganizerName ?? Model.OrganizerId ?? "-")</p>
                <div class="mt-3">
                    <strong>Mô tả</strong>
                    <div class="border rounded p-3 bg-light">@Html.Raw(Model.Description?.Replace("\n", "<br />"))</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Tình trạng</h5>
                <p><span class="badge @GetApprovalBadge(Model.ApprovalStatus)">@Model.ApprovalStatus</span></p>
                <p><span class="badge @GetStatusBadge(Model.Status)">@Model.Status</span></p>
                <p class="mb-1"><strong>Đăng ký:</strong> @Model.RegisteredCount</p>
                <p class="mb-3"><strong>Đã điểm danh:</strong> @Model.CheckinCount</p>
                <div class="btn-group w-100 mb-2">
                    <button type="button" class="btn btn-sm btn-outline-success js-approve" data-id="@Model.Id"><i class="fa-solid fa-check me-1"></i>Phê duyệt</button>
                    <button type="button" class="btn btn-sm btn-outline-danger js-reject" data-id="@Model.Id"><i class="fa-solid fa-xmark me-1"></i>Từ chối</button>
                </div>
                <div class="btn-group w-100 mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary js-submit" data-id="@Model.Id"><i class="fa-solid fa-paper-plane me-1"></i>Gửi duyệt</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary js-open" data-id="@Model.Id"><i class="fa-solid fa-door-open me-1"></i>Mở</button>
                    <button type="button" class="btn btn-sm btn-outline-warning js-close" data-id="@Model.Id"><i class="fa-solid fa-door-closed me-1"></i>Đóng</button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger w-100 js-delete" data-id="@Model.Id"><i class="fa-solid fa-trash me-1"></i>Xoá hoạt động</button>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Phê duyệt</h5>
                <p class="mb-1"><strong>Người duyệt:</strong> @Model.ApprovedBy</p>
                <p class="mb-0"><strong>Thời gian:</strong> @(Model.ApprovedAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</p>
            </div>
        </div>
    </div>
</div>

<form id="antiForgeryForm" method="post">
    <input type="hidden" name="__RequestVerificationToken" value="@token" />
</form>

@await Html.PartialAsync("_ApproveModal")

@section Scripts {
    <script src="~/js/admin.activities.js" asp-append-version="true"></script>
}

@functions {
    private string GetApprovalBadge(string status)
    {
        return status?.ToUpperInvariant() switch
        {
            "APPROVED" => "badge badge-approval-approved",
            "REJECTED" => "badge badge-approval-rejected",
            _ => "badge badge-approval-pending"
        };
    }

    private string GetStatusBadge(string status)
    {
        return status?.ToUpperInvariant() switch
        {
            "OPEN" => "badge badge-status-open",
            "CLOSED" => "badge badge-status-closed",
            "CANCELLED" => "badge badge-status-cancelled",
            _ => "badge bg-secondary"
        };
    }
}
