@model QLDiemRenLuyen.Admin.Models.ViewModels.AdminActivitiesVm
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Hoạt động";
    var token = Antiforgery.GetAndStoreTokens(HttpContext).RequestToken;
}

<section class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4 mb-0">Danh sách hoạt động toàn khoa</h2>
        <a class="btn btn-primary" asp-action="Create"><i class="fa-solid fa-plus me-2"></i>Thêm hoạt động</a>
    </div>
    <form class="row g-3" method="get">
        <div class="col-md-3">
            <label class="form-label">Học kỳ</label>
            <select class="form-select" name="termId">
                <option value="">Tất cả</option>
                @foreach (var term in Model.Terms)
                {
                    <option value="@term.Id" selected="@(term.Id == Model.SelectedTermId)">@term.Name</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Từ khóa</label>
            <input class="form-control" type="text" name="q" value="@Model.Keyword" placeholder="Tên hoạt động" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Trạng thái phê duyệt</label>
            <select class="form-select" name="approval">
                <option value="ALL" selected="@(Model.ApprovalFilter == "ALL")">Tất cả</option>
                <option value="PENDING" selected="@(Model.ApprovalFilter == "PENDING")">Chờ duyệt</option>
                <option value="APPROVED" selected="@(Model.ApprovalFilter == "APPROVED")">Đã duyệt</option>
                <option value="REJECTED" selected="@(Model.ApprovalFilter == "REJECTED")">Từ chối</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Trạng thái đăng ký</label>
            <select class="form-select" name="status">
                <option value="ALL" selected="@(Model.StatusFilter == "ALL")">Tất cả</option>
                <option value="OPEN" selected="@(Model.StatusFilter == "OPEN")">Đang mở</option>
                <option value="CLOSED" selected="@(Model.StatusFilter == "CLOSED")">Đã đóng</option>
                <option value="FULL" selected="@(Model.StatusFilter == "FULL")">Đủ số lượng</option>
            </select>
        </div>
        <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-outline-secondary me-2" type="reset" onclick="window.location='@Url.Action("Index")'">Đặt lại</button>
            <button class="btn btn-primary" type="submit"><i class="fa-solid fa-filter me-2"></i>Lọc</button>
        </div>
    </form>
</section>

<section>
    @if (!Model.Items.Data.Any())
    {
        <div class="alert alert-info"><i class="fa-solid fa-circle-info me-2"></i>Chưa có hoạt động nào phù hợp.</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4" id="activityCards">
            @foreach (var activity in Model.Items.Data)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge @GetApprovalBadge(activity.ApprovalStatus)">@activity.ApprovalStatus</span>
                                <span class="badge @GetStatusBadge(activity.Status)">@activity.Status</span>
                            </div>
                            <h3 class="h5">@activity.Title</h3>
                            <p class="text-muted small mb-2"><i class="fa-solid fa-calendar-days me-1"></i>@(activity.StartAt?.ToString("dd/MM/yyyy HH:mm") ?? "-") - @(activity.EndAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</p>
                            <p class="text-muted small mb-2"><i class="fa-solid fa-graduation-cap me-1"></i>@activity.TermName</p>
                            <p class="text-muted small mb-2"><i class="fa-solid fa-user-tie me-1"></i>@activity.OrganizerName</p>
                            <p class="text-muted small mb-3"><i class="fa-solid fa-users me-1"></i>@activity.RegisteredCount/@(activity.Seats?.ToString() ?? "∞")</p>
                            <div class="mt-auto">
                                <div class="btn-group w-100 mb-2" role="group">
                                    <a class="btn btn-sm btn-outline-primary" asp-action="Detail" asp-route-id="@activity.Id"><i class="fa-solid fa-eye"></i></a>
                                    <a class="btn btn-sm btn-outline-secondary" asp-action="Edit" asp-route-id="@activity.Id"><i class="fa-solid fa-pen"></i></a>
                                    <button type="button" class="btn btn-sm btn-outline-success js-open" data-id="@activity.Id"><i class="fa-solid fa-door-open"></i></button>
                                    <button type="button" class="btn btn-sm btn-outline-warning js-close" data-id="@activity.Id"><i class="fa-solid fa-door-closed"></i></button>
                                </div>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-success js-approve" data-id="@activity.Id"><i class="fa-solid fa-check"></i></button>
                                    <button type="button" class="btn btn-sm btn-outline-danger js-reject" data-id="@activity.Id"><i class="fa-solid fa-xmark"></i></button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary js-submit" data-id="@activity.Id"><i class="fa-solid fa-paper-plane"></i></button>
                                    <button type="button" class="btn btn-sm btn-outline-danger js-delete" data-id="@activity.Id"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                var totalPages = Model.Items.TotalPages > 0 ? Model.Items.TotalPages : 1;
                for (var i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == Model.Items.Page ? "active" : string.Empty)">
                        <a class="page-link" href="@Url.Action("Index", new { termId = Model.SelectedTermId, q = Model.Keyword, approval = Model.ApprovalFilter, status = Model.StatusFilter, page = i, pageSize = Model.Items.PageSize })">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</section>

<form id="antiForgeryForm" method="post">
    <input type="hidden" name="__RequestVerificationToken" value="@token" />
</form>

@await Html.PartialAsync("_ApproveModal")

@section Scripts {
    <script src="~/js/admin.activities.js" asp-append-version="true"></script>
}

@functions {
    private string GetApprovalBadge(string status)
    {
        return status?.ToUpperInvariant() switch
        {
            "APPROVED" => "badge badge-approval-approved",
            "REJECTED" => "badge badge-approval-rejected",
            _ => "badge badge-approval-pending"
        };
    }

    private string GetStatusBadge(string status)
    {
        return status?.ToUpperInvariant() switch
        {
            "OPEN" => "badge badge-status-open",
            "CLOSED" => "badge badge-status-closed",
            "FULL" => "badge badge-status-full",
            _ => "badge bg-secondary"
        };
    }
}
